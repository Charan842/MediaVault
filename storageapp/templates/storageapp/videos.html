{% extends 'storageapp/base.html' %}

{% block title %}My Videos{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.css" rel="stylesheet">
<style>
.sortable-ghost {
    opacity: 0.5;
}
.sortable-chosen {
    transform: rotate(5deg);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}
.video-item {
    transition: all 0.3s ease;
}
.video-item.reorder-active {
    border: 2px dashed #ffc107;
    background: #fffbe6;
    cursor: grab !important;
    touch-action: none !important;
    /* Mobile optimizations */
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
.reorder-indicator {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8em;
    z-index: 10;
}
@media (max-width: 768px) {
    .reorder-indicator {
        font-size: 0.7em;
        padding: 1px 4px;
    }
    .video-item.reorder-active {
        /* Larger touch target for mobile */
        min-height: 120px;
    }
    .video-item.reorder-active .card {
        /* Ensure the entire card is draggable */
        cursor: grab !important;
        touch-action: none !important;
    }
}
/* Android Chrome specific optimizations */
@media (max-width: 768px) {
    .video-item.reorder-active * {
        pointer-events: none;
    }
    .video-item.reorder-active {
        pointer-events: auto;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-video"></i> My Videos</h1>
    <div class="d-flex gap-2 align-items-center">
        <button id="toggleReorderVideos" class="btn btn-outline-warning btn-sm d-none d-lg-block">
            <i class="fas fa-arrows-alt"></i> Toggle Reorder Mode
        </button>
        <form method="get" class="d-flex align-items-center gap-2" id="sort-filter-video-form">
            <label for="sort-video" class="form-label mb-0">Sort by:</label>
            <select name="sort" id="sort-video" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest</option>
                <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>Oldest</option>
                <option value="largest" {% if sort == 'largest' %}selected{% endif %}>Largest</option>
                <option value="smallest" {% if sort == 'smallest' %}selected{% endif %}>Smallest</option>
                <option value="title_az" {% if sort == 'title_az' %}selected{% endif %}>Title A-Z</option>
                <option value="title_za" {% if sort == 'title_za' %}selected{% endif %}>Title Z-A</option>
            </select>
            <label for="filter-video" class="form-label mb-0">Filter:</label>
            <select name="filter" id="filter-video" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="all" {% if date_filter == 'all' %}selected{% endif %}>All Time</option>
                <option value="month" {% if date_filter == 'month' %}selected{% endif %}>This Month</option>
                <option value="year" {% if date_filter == 'year' %}selected{% endif %}>This Year</option>
            </select>
        </form>
        <a href="{% url 'upload_video' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Upload New Video
        </a>
    </div>
</div>
{% if reorder_mode_hint %}<div class="alert alert-info text-center mb-2" id="reorderHint" style="display:none;">Long-press and drag to reorder on mobile/tablet.</div>{% endif %}

{% if videos %}
    <form method="post" action="{% url 'delete_videos' %}" id="bulk-action-videos-form">
        {% csrf_token %}
        <div class="mb-3 d-flex gap-2 align-items-center">
            <button type="button" class="btn btn-danger" id="delete-selected-videos-btn" disabled data-bs-toggle="modal" data-bs-target="#bulkDeleteVideosModal" aria-label="Delete selected videos">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
            <button type="submit" class="btn btn-success" id="download-selected-videos-btn" disabled aria-label="Download selected videos">
                <i class="fas fa-download"></i> Download Selected
            </button>
            <button type="button" class="btn btn-warning" id="create-album-btn" disabled data-bs-toggle="modal" data-bs-target="#createAlbumModal" aria-label="Create album from selected videos">
                <i class="fas fa-folder-plus"></i> Create Album from Selection
            </button>
            <div class="form-check ms-3">
                <input class="form-check-input" type="checkbox" id="select-all-videos" aria-label="Select all videos">
                <label class="form-check-label" for="select-all-videos">Select All</label>
            </div>
        </div>
        <div id="videosContainer" class="row row-cols-1 row-cols-sm-2 row-cols-md-2 row-cols-lg-3 g-4" role="list">
            {% for video in videos %}
                <div class="col video-item" data-id="{{ video.id }}" data-order="{{ forloop.counter0 }}">
                    <div class="card h-100 shadow-sm position-relative" role="listitem">
                        <div class="reorder-indicator" style="display: none;">Drag to reorder</div>
                        <div class="form-check position-absolute m-2" style="z-index:2;">
                            <input class="form-check-input video-checkbox" type="checkbox" name="video_ids" value="{{ video.id }}" id="video-check-{{ video.id }}" aria-label="Select video {{ video.title|default:'Untitled' }}">
                        </div>
                        <a href="{% url 'video_detail' video.id %}">
                            {% if video.thumbnail %}
                                <img src="{{ video.thumbnail.url }}" class="card-img-top" alt="Thumbnail for {{ video.title|default:'Video' }} by {{ video.user.username }}">
                            {% else %}
                                <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height:180px;">
                                    <i class="fas fa-video fa-3x" aria-label="No thumbnail available"></i>
                                </div>
                            {% endif %}
                        </a>
                        <div class="card-body">
                            <h5 class="card-title">{{ video.title|default:"Untitled" }}</h5>
                            <p class="card-text text-muted small">
                                Uploaded on {{ video.uploaded_at|date:"M d, Y" }}<br>
                                <span>Size: {{ video.file_size|filesizeformat }}</span>
                                {% if video.duration %}<br><span>Duration: {{ video.duration|time:"H:i:s" }}</span>{% endif %}
                            </p>
                        </div>
                        <div class="card-footer text-center">
                            <a href="{% url 'video_detail' video.id %}" class="btn btn-sm btn-outline-primary" aria-label="View video {{ video.title|default:'Untitled' }}">
                                <i class="fas fa-eye"></i> View
                            </a>
                            <form action="{% url 'delete_video' video.id %}" method="post" class="d-inline single-delete-video-form">
                                {% csrf_token %}
                                <button type="button" class="btn btn-sm btn-outline-danger single-delete-video-btn" aria-label="Delete video {{ video.title|default:'Untitled' }}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <!-- Infinite Scroll Loading Indicator -->
        <div id="loading-indicator" class="text-center py-4" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2 text-muted">Loading more videos...</div>
        </div>
        <!-- End of Content Indicator -->
        <div id="end-indicator" class="text-center py-4" style="display: none;">
            <div class="text-muted">
                <i class="fas fa-check-circle"></i> You've reached the end of your videos
            </div>
        </div>
    </form>
    <!-- Spinner Overlay for Bulk Actions -->
    <div id="bulk-video-spinner-overlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);z-index:9999;align-items:center;justify-content:center;">
        <div class="spinner-border text-primary" style="width:4rem;height:4rem;" role="status">
            <span class="visually-hidden">Processing...</span>
        </div>
        <div class="mt-3 text-primary h4">Processing, please wait...</div>
    </div>
    <!-- Bulk Delete Modal -->
    <div class="modal fade" id="bulkDeleteVideosModal" tabindex="-1" aria-labelledby="bulkDeleteVideosModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="bulkDeleteVideosModalLabel">Confirm Bulk Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete the selected videos?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-bulk-delete-videos">Delete</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Single Delete Modal -->
    <div class="modal fade" id="singleDeleteVideoModal" tabindex="-1" aria-labelledby="singleDeleteVideoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="singleDeleteVideoModalLabel">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this video?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-single-delete-video">Delete</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Create Album Modal -->
    <div class="modal fade" id="createAlbumModal" tabindex="-1" aria-labelledby="createAlbumModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form method="post" action="{% url 'album_create' %}" id="create-album-form">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="createAlbumModalLabel">Create Album from Selected Videos</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="album-name" class="form-label">Album Name</label>
                <input type="text" class="form-control" id="album-name" name="name" required>
              </div>
              <div class="mb-3">
                <label for="album-description" class="form-label">Description</label>
                <textarea class="form-control" id="album-description" name="description" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label for="album-cover" class="form-label">Cover Image (optional)</label>
                <input type="file" class="form-control" id="album-cover" name="cover_image">
              </div>
              <input type="hidden" name="video_ids" id="selected-video-ids">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-warning">Create Album</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script>
    function updateBulkVideoButtons() {
        var anyChecked = document.querySelectorAll('.video-checkbox:checked').length > 0;
        document.getElementById('delete-selected-videos-btn').disabled = !anyChecked;
        document.getElementById('download-selected-videos-btn').disabled = !anyChecked;
        document.getElementById('create-album-btn').disabled = !anyChecked;
    }
    document.getElementById('download-selected-videos-btn').addEventListener('click', function(e) {
        var form = document.getElementById('bulk-action-videos-form');
        form.action = "{% url 'download_videos' %}";
        form.target = "_blank";
    });
    document.querySelector('button.btn-danger').addEventListener('click', function(e) {
        var form = document.getElementById('bulk-action-videos-form');
        form.action = "{% url 'delete_videos' %}";
        form.removeAttribute('target');
    });
    // Select All functionality
    document.getElementById('select-all-videos').addEventListener('change', function(e) {
        var checked = this.checked;
        document.querySelectorAll('.video-checkbox').forEach(function(cb) {
            cb.checked = checked;
        });
        updateBulkVideoButtons();
    });
    document.querySelectorAll('.video-checkbox').forEach(function(cb) {
        cb.addEventListener('change', updateBulkVideoButtons);
    });
    // Initial state
    updateBulkVideoButtons();
    // Spinner on bulk action submit
    document.getElementById('bulk-action-videos-form').addEventListener('submit', function() {
        document.getElementById('bulk-video-spinner-overlay').style.display = 'flex';
    });
    // Bulk Delete Modal
    let bulkDeleteVideosForm = document.getElementById('bulk-action-videos-form');
    document.getElementById('confirm-bulk-delete-videos').onclick = function() {
        document.getElementById('bulkDeleteVideosModal').classList.remove('show');
        document.body.classList.remove('modal-open');
        document.querySelector('.modal-backdrop').remove();
        bulkDeleteVideosForm.submit();
    };
    // Intercept bulk delete button
    let deleteSelectedVideosBtn = document.getElementById('delete-selected-videos-btn');
    deleteSelectedVideosBtn.addEventListener('click', function(e) {
        e.preventDefault();
    });
    // Single Delete Modal
    let singleDeleteVideoFormToSubmit = null;
    document.querySelectorAll('.single-delete-video-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            singleDeleteVideoFormToSubmit = btn.closest('form');
            var modal = new bootstrap.Modal(document.getElementById('singleDeleteVideoModal'));
            modal.show();
        });
    });
    document.getElementById('confirm-single-delete-video').onclick = function() {
        if (singleDeleteVideoFormToSubmit) {
            document.getElementById('singleDeleteVideoModal').classList.remove('show');
            document.body.classList.remove('modal-open');
            document.querySelector('.modal-backdrop').remove();
            singleDeleteVideoFormToSubmit.submit();
        }
    };
    // Enable/disable Create Album button
    function updateBulkButtons() {
        var anyChecked = document.querySelectorAll('.video-checkbox:checked').length > 0;
        document.getElementById('delete-selected-videos-btn').disabled = !anyChecked;
        document.getElementById('download-selected-videos-btn').disabled = !anyChecked;
        document.getElementById('create-album-btn').disabled = !anyChecked;
    }
    // Set selected video IDs in modal form
    document.getElementById('create-album-btn').addEventListener('click', function() {
        var checked = document.querySelectorAll('.video-checkbox:checked');
        var ids = Array.from(checked).map(cb => cb.value).join(',');
        document.getElementById('selected-video-ids').value = ids;
    });
    </script>
{% else %}
    <div class="text-center py-5">
        <i class="fas fa-video fa-4x text-muted mb-3"></i>
        <h3>No Videos Found</h3>
        <p class="lead">You haven't uploaded any videos yet.</p>
        <a href="{% url 'upload_video' %}" class="btn btn-lg btn-primary mt-3">
            <i class="fas fa-upload"></i> Upload Your First Video
        </a>
    </div>
{% endif %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let reorderMode = false;
    let videosSortable;
    let currentPage = 1;
    let isLoading = false;
    let hasMoreVideos = true;
    const toggleButton = document.getElementById('toggleReorderVideos');
    const videosContainer = document.getElementById('videosContainer');
    const reorderHint = document.getElementById('reorderHint');
    const loadingIndicator = document.getElementById('loading-indicator');
    const endIndicator = document.getElementById('end-indicator');

    // Get current sort and filter parameters
    const urlParams = new URLSearchParams(window.location.search);
    const currentSort = urlParams.get('sort') || 'newest';
    const currentFilter = urlParams.get('filter') || 'all';

    // Infinite Scroll Functionality
    function loadMoreVideos() {
        if (isLoading || !hasMoreVideos) {
            console.log('Skipping load - isLoading:', isLoading, 'hasMoreVideos:', hasMoreVideos);
            return;
        }
        
        console.log('Starting to load more videos, page:', currentPage + 1);
        isLoading = true;
        loadingIndicator.style.display = 'block';
        
        const url = `{% url 'videos_ajax' %}?page=${currentPage + 1}&sort=${currentSort}&filter=${currentFilter}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('Received data:', data);
                if (data.videos && data.videos.length > 0) {
                    data.videos.forEach(video => {
                        const videoHtml = createVideoHTML(video);
                        videosContainer.insertAdjacentHTML('beforeend', videoHtml);
                    });
                    currentPage = data.current_page;
                    hasMoreVideos = data.has_next;
                    console.log('Loaded videos, new page:', currentPage, 'hasMore:', hasMoreVideos);
                    
                    // Reinitialize event listeners for new videos
                    initializeNewVideoEventListeners();
                } else {
                    hasMoreVideos = false;
                    console.log('No more videos to load');
                }
                
                if (!hasMoreVideos) {
                    endIndicator.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading videos:', error);
            })
            .finally(() => {
                isLoading = false;
                loadingIndicator.style.display = 'none';
            });
    }

    function createVideoHTML(video) {
        const thumbnailHtml = video.thumbnail_url 
            ? `<img src="${video.thumbnail_url}" class="card-img-top" alt="${video.title} thumbnail">`
            : `<div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height:180px;">
                 <i class="fas fa-video fa-3x" aria-label="No thumbnail available"></i>
               </div>`;

        const durationHtml = video.duration 
            ? `<br><span>Duration: ${video.duration}</span>`
            : '';

        return `
            <div class="col video-item" data-id="${video.id}" data-order="${currentPage * 8 + 1}">
                <div class="card h-100 shadow-sm position-relative" role="listitem">
                    <div class="reorder-indicator" style="display: none;">Drag to reorder</div>
                    <div class="form-check position-absolute m-2" style="z-index:2;">
                        <input class="form-check-input video-checkbox" type="checkbox" name="video_ids" value="${video.id}" id="video-check-${video.id}" aria-label="Select video ${video.title}">
                    </div>
                    <a href="/video/${video.id}/">
                        ${thumbnailHtml}
                    </a>
                    <div class="card-body">
                        <h5 class="card-title">${video.title}</h5>
                        <p class="card-text text-muted small">
                            Uploaded on ${video.uploaded_at}<br>
                            <span>Size: ${video.file_size_formatted}</span>${durationHtml}
                        </p>
                    </div>
                    <div class="card-footer text-center">
                        <a href="/video/${video.id}/" class="btn btn-sm btn-outline-primary" aria-label="View video ${video.title}">
                            <i class="fas fa-eye"></i> View
                        </a>
                        <form action="/video/${video.id}/delete/" method="post" class="d-inline single-delete-video-form">
                            {% csrf_token %}
                            <button type="button" class="btn btn-sm btn-outline-danger single-delete-video-btn" aria-label="Delete video ${video.title}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        `;
    }

    function initializeNewVideoEventListeners() {
        // Add event listeners for new video checkboxes
        const newCheckboxes = videosContainer.querySelectorAll('.video-checkbox:not([data-initialized])');
        newCheckboxes.forEach(cb => {
            cb.addEventListener('change', updateBulkVideoButtons);
            cb.setAttribute('data-initialized', 'true');
        });

        // Add event listeners for new delete buttons
        const newDeleteBtns = videosContainer.querySelectorAll('.single-delete-video-btn:not([data-initialized])');
        newDeleteBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                singleDeleteVideoFormToSubmit = btn.closest('form');
                var modal = new bootstrap.Modal(document.getElementById('singleDeleteVideoModal'));
                modal.show();
            });
            btn.setAttribute('data-initialized', 'true');
        });
    }

    // Intersection Observer for infinite scroll
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && hasMoreVideos && !isLoading) {
                console.log('Loading more videos...'); // Debug log
                loadMoreVideos();
            }
        });
    }, {
        rootMargin: '200px', // Increased margin to trigger earlier
        threshold: 0.1
    });

    // Observe the loading indicator
    if (loadingIndicator) {
        observer.observe(loadingIndicator);
        console.log('Observer set up for loading indicator'); // Debug log
    }

    // Also observe the end indicator as a fallback
    if (endIndicator) {
        observer.observe(endIndicator);
    }

    function initializeSortable() {
        if (videosContainer) {
            videosSortable = new Sortable(videosContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                disabled: true,
                // Mobile drag: instant drag on touch
                delay: 0,
                touchStartThreshold: 1,
                // Android Chrome specific options
                preventOnFilter: false,
                onStart: function(evt) {
                    // Ensure touch events work properly
                    if (evt.originalEvent && evt.originalEvent.touches) {
                        evt.originalEvent.preventDefault();
                    }
                },
                onEnd: function(evt) {
                    if (reorderMode) {
                        const item = evt.item;
                        const newIndex = evt.newIndex;
                        const videoId = item.dataset.id;
                        // Update data-order attributes
                        const items = videosContainer.querySelectorAll('.video-item');
                        items.forEach((item, index) => {
                            item.dataset.order = index;
                        });
                        reorderVideo(videoId, newIndex);
                    }
                }
            });
        }
    }

    function toggleReorderMode() {
        reorderMode = !reorderMode;
        if (reorderMode) {
            toggleButton.innerHTML = '<i class="fas fa-check"></i> Exit Reorder Mode';
            toggleButton.classList.remove('btn-outline-warning');
            toggleButton.classList.add('btn-warning');
            if (videosSortable) videosSortable.option('disabled', false);
            document.querySelectorAll('.reorder-indicator').forEach(ind => ind.style.display = 'block');
            document.querySelectorAll('.video-item').forEach(item => {
                item.classList.add('reorder-active');
            });
            if (reorderHint) reorderHint.style.display = 'block';
        } else {
            toggleButton.innerHTML = '<i class="fas fa-arrows-alt"></i> Toggle Reorder Mode';
            toggleButton.classList.remove('btn-warning');
            toggleButton.classList.add('btn-outline-warning');
            if (videosSortable) videosSortable.option('disabled', true);
            document.querySelectorAll('.reorder-indicator').forEach(ind => ind.style.display = 'none');
            document.querySelectorAll('.video-item').forEach(item => {
                item.classList.remove('reorder-active');
            });
            if (reorderHint) reorderHint.style.display = 'none';
        }
    }

    // Initialize existing functionality
    initializeSortable();
    if (toggleButton) toggleButton.addEventListener('click', toggleReorderMode);
    
    // Initialize event listeners for existing videos
    initializeNewVideoEventListeners();

    // Add scroll event listener as fallback for infinite scroll
    window.addEventListener('scroll', function() {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 300) {
            if (hasMoreVideos && !isLoading) {
                console.log('Scroll fallback triggered');
                loadMoreVideos();
            }
        }
    });

    // Initial check - if we have less than 8 videos, we might not need infinite scroll
    const initialVideos = videosContainer.querySelectorAll('.video-item');
    if (initialVideos.length < 8) {
        console.log('Less than 8 videos initially, checking if we need to load more');
        hasMoreVideos = false;
        endIndicator.style.display = 'block';
    }
});
</script>
{% endblock %}
{% endblock %} 