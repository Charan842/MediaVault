{% extends 'storageapp/base.html' %}

{% block title %}My Photos{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.css" rel="stylesheet">
<style>
.sortable-ghost {
    opacity: 0.5;
}
.sortable-chosen {
    transform: rotate(5deg);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}
.photo-item {
    transition: all 0.3s ease;
}
.photo-item.reorder-active {
    border: 2px dashed #ffc107;
    background: #fffbe6;
    cursor: grab !important;
    touch-action: none !important;
    /* Mobile optimizations */
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
.reorder-indicator {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8em;
    z-index: 10;
}
@media (max-width: 768px) {
    .reorder-indicator {
        font-size: 0.7em;
        padding: 1px 4px;
    }
    .photo-item.reorder-active {
        /* Larger touch target for mobile */
        min-height: 120px;
    }
    .photo-item.reorder-active .card {
        /* Ensure the entire card is draggable */
        cursor: grab !important;
        touch-action: none !important;
    }
}
/* Android Chrome specific optimizations */
@media (max-width: 768px) {
    .photo-item.reorder-active * {
        pointer-events: none;
    }
    .photo-item.reorder-active {
        pointer-events: auto;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-images"></i> My Photos</h1>
    <div class="d-flex gap-2 align-items-center">
        <button id="toggleReorderPhotos" class="btn btn-outline-warning btn-sm d-none d-lg-block">
            <i class="fas fa-arrows-alt"></i> Toggle Reorder Mode
        </button>
        <form method="get" class="d-flex align-items-center gap-2" id="sort-filter-form">
            <label for="sort-photo" class="form-label mb-0">Sort by:</label>
            <select name="sort" id="sort-photo" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest</option>
                <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>Oldest</option>
                <option value="largest" {% if sort == 'largest' %}selected{% endif %}>Largest</option>
                <option value="smallest" {% if sort == 'smallest' %}selected{% endif %}>Smallest</option>
                <option value="title_az" {% if sort == 'title_az' %}selected{% endif %}>Title A-Z</option>
                <option value="title_za" {% if sort == 'title_za' %}selected{% endif %}>Title Z-A</option>
            </select>
            <label for="filter-photo" class="form-label mb-0">Filter:</label>
            <select name="filter" id="filter-photo" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="all" {% if date_filter == 'all' %}selected{% endif %}>All Time</option>
                <option value="month" {% if date_filter == 'month' %}selected{% endif %}>This Month</option>
                <option value="year" {% if date_filter == 'year' %}selected{% endif %}>This Year</option>
            </select>
        </form>
        <a href="{% url 'upload_photo' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Upload New Photo
        </a>
    </div>
</div>
{% if reorder_mode_hint %}<div class="alert alert-info text-center mb-2" id="reorderHint" style="display:none;">Long-press and drag to reorder on mobile/tablet.</div>{% endif %}

{% if photos %}
    <form method="post" action="{% url 'delete_photos' %}" id="bulk-action-form">
        {% csrf_token %}
        <div class="mb-3 d-flex gap-2 align-items-center">
            <button type="button" class="btn btn-danger" id="delete-selected-btn" disabled data-bs-toggle="modal" data-bs-target="#bulkDeleteModal" aria-label="Delete selected photos">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
            <button type="submit" class="btn btn-success" id="download-selected-btn" disabled aria-label="Download selected photos">
                <i class="fas fa-download"></i> Download Selected
            </button>
            <button type="button" class="btn btn-warning" id="create-album-btn" disabled data-bs-toggle="modal" data-bs-target="#createAlbumModal" aria-label="Create album from selected photos">
                <i class="fas fa-folder-plus"></i> Create Album from Selection
            </button>
            <div class="form-check ms-3">
                <input class="form-check-input" type="checkbox" id="select-all-photos" aria-label="Select all photos">
                <label class="form-check-label" for="select-all-photos">Select All</label>
            </div>
        </div>
        <div id="photosContainer" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4" role="list">
            {% for photo in photos %}
                <div class="col photo-item" data-id="{{ photo.id }}" data-order="{{ forloop.counter0 }}">
                    <div class="card h-100 shadow-sm position-relative" role="listitem">
                        <div class="reorder-indicator" style="display: none;">Drag to reorder</div>
                        <div class="form-check position-absolute m-2" style="z-index:2;">
                            <input class="form-check-input photo-checkbox" type="checkbox" name="photo_ids" value="{{ photo.id }}" id="photo-check-{{ photo.id }}" aria-label="Select photo {{ photo.title|default:'Untitled' }}">
                        </div>
                        <a href="{% url 'photo_detail' photo.id %}">
                            <img src="{{ photo.image.url }}" class="card-img-top" alt="{{ photo.title|default:'Photo' }} by {{ photo.user.username }}">
                        </a>
                        <div class="card-body">
                            <h5 class="card-title">{{ photo.title|default:"Untitled" }}</h5>
                            <p class="card-text text-muted small">
                                Uploaded on {{ photo.uploaded_at|date:"M d, Y" }}<br>
                                <span>Size: {{ photo.file_size|filesizeformat }}</span>
                            </p>
                        </div>
                        <div class="card-footer text-center">
                            <a href="{% url 'photo_detail' photo.id %}" class="btn btn-sm btn-outline-primary" aria-label="View photo {{ photo.title|default:'Untitled' }}">
                                <i class="fas fa-eye"></i> View
                            </a>
                            <form action="{% url 'delete_photo' photo.id %}" method="post" class="d-inline single-delete-form">
                                {% csrf_token %}
                                <button type="button" class="btn btn-sm btn-outline-danger single-delete-btn" aria-label="Delete photo {{ photo.title|default:'Untitled' }}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <!-- Infinite Scroll Loading Indicator -->
        <div id="loading-indicator" class="text-center py-4" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2 text-muted">Loading more photos...</div>
        </div>
        <!-- End of Content Indicator -->
        <div id="end-indicator" class="text-center py-4" style="display: none;">
            <div class="text-muted">
                <i class="fas fa-check-circle"></i> You've reached the end of your photos
            </div>
        </div>
    </form>
    <!-- Spinner Overlay for Bulk Actions -->
    <div id="bulk-spinner-overlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);z-index:9999;align-items:center;justify-content:center;">
        <div class="spinner-border text-primary" style="width:4rem;height:4rem;" role="status">
            <span class="visually-hidden">Processing...</span>
        </div>
        <div class="mt-3 text-primary h4">Processing, please wait...</div>
    </div>
    <!-- Bulk Delete Modal -->
    <div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="bulkDeleteModalLabel">Confirm Bulk Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete the selected photos?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-bulk-delete">Delete</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Single Delete Modal -->
    <div class="modal fade" id="singleDeleteModal" tabindex="-1" aria-labelledby="singleDeleteModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="singleDeleteModalLabel">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this photo?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-single-delete">Delete</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Create Album Modal -->
    <div class="modal fade" id="createAlbumModal" tabindex="-1" aria-labelledby="createAlbumModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form method="post" action="{% url 'album_create' %}" id="create-album-form">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="createAlbumModalLabel">Create Album from Selected Photos</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="album-name" class="form-label">Album Name</label>
                <input type="text" class="form-control" id="album-name" name="name" required>
              </div>
              <div class="mb-3">
                <label for="album-description" class="form-label">Description</label>
                <textarea class="form-control" id="album-description" name="description" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label for="album-cover" class="form-label">Cover Image (optional)</label>
                <input type="file" class="form-control" id="album-cover" name="cover_image">
              </div>
              <input type="hidden" name="photo_ids" id="selected-photo-ids">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-warning">Create Album</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script>
    function updateBulkButtons() {
        var anyChecked = document.querySelectorAll('.photo-checkbox:checked').length > 0;
        document.getElementById('delete-selected-btn').disabled = !anyChecked;
        document.getElementById('download-selected-btn').disabled = !anyChecked;
        document.getElementById('create-album-btn').disabled = !anyChecked;
    }
    document.getElementById('download-selected-btn').addEventListener('click', function(e) {
        var form = document.getElementById('bulk-action-form');
        form.action = "{% url 'download_photos' %}";
        form.target = "_blank";
    });
    document.querySelector('button.btn-danger').addEventListener('click', function(e) {
        var form = document.getElementById('bulk-action-form');
        form.action = "{% url 'delete_photos' %}";
        form.removeAttribute('target');
    });
    // Select All functionality
    document.getElementById('select-all-photos').addEventListener('change', function(e) {
        var checked = this.checked;
        document.querySelectorAll('.photo-checkbox').forEach(function(cb) {
            cb.checked = checked;
        });
        updateBulkButtons();
    });
    document.querySelectorAll('.photo-checkbox').forEach(function(cb) {
        cb.addEventListener('change', updateBulkButtons);
    });
    // Initial state
    updateBulkButtons();
    // Spinner on bulk action submit
    document.getElementById('bulk-action-form').addEventListener('submit', function() {
        document.getElementById('bulk-spinner-overlay').style.display = 'flex';
    });
    // Bulk Delete Modal
    let bulkDeleteForm = document.getElementById('bulk-action-form');
    document.getElementById('confirm-bulk-delete').onclick = function() {
        document.getElementById('bulkDeleteModal').classList.remove('show');
        document.body.classList.remove('modal-open');
        document.querySelector('.modal-backdrop').remove();
        bulkDeleteForm.submit();
    };
    // Intercept bulk delete button
    let deleteSelectedBtn = document.getElementById('delete-selected-btn');
    deleteSelectedBtn.addEventListener('click', function(e) {
        e.preventDefault();
    });
    // Single Delete Modal
    let singleDeleteFormToSubmit = null;
    document.querySelectorAll('.single-delete-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            singleDeleteFormToSubmit = btn.closest('form');
            var modal = new bootstrap.Modal(document.getElementById('singleDeleteModal'));
            modal.show();
        });
    });
    document.getElementById('confirm-single-delete').onclick = function() {
        if (singleDeleteFormToSubmit) {
            document.getElementById('singleDeleteModal').classList.remove('show');
            document.body.classList.remove('modal-open');
            document.querySelector('.modal-backdrop').remove();
            singleDeleteFormToSubmit.submit();
        }
    };
    // Set selected photo IDs in modal form
    document.getElementById('create-album-btn').addEventListener('click', function() {
        var checked = document.querySelectorAll('.photo-checkbox:checked');
        var ids = Array.from(checked).map(cb => cb.value).join(',');
        document.getElementById('selected-photo-ids').value = ids;
    });
    </script>
{% else %}
    <div class="text-center py-5">
        <i class="fas fa-image fa-4x text-muted mb-3"></i>
        <h3>No Photos Found</h3>
        <p class="lead">You haven't uploaded any photos yet.</p>
        <a href="{% url 'upload_photo' %}" class="btn btn-lg btn-primary mt-3">
            <i class="fas fa-upload"></i> Upload Your First Photo
        </a>
    </div>
{% endif %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let reorderMode = false;
    let photosSortable;
    let currentPage = 1;
    let isLoading = false;
    let hasMorePhotos = true;
    const toggleButton = document.getElementById('toggleReorderPhotos');
    const photosContainer = document.getElementById('photosContainer');
    const reorderHint = document.getElementById('reorderHint');
    const loadingIndicator = document.getElementById('loading-indicator');
    const endIndicator = document.getElementById('end-indicator');

    // Infinite Scroll Functionality
    function loadMorePhotos() {
        if (isLoading || !hasMorePhotos) {
            console.log('Skipping load - isLoading:', isLoading, 'hasMorePhotos:', hasMorePhotos);
            return;
        }
        
        console.log('Starting to load more photos, page:', currentPage + 1);
        isLoading = true;
        loadingIndicator.style.display = 'block';
        
        fetch(`{% url 'photos_ajax' %}?page=${currentPage + 1}`)
            .then(response => response.json())
            .then(data => {
                console.log('Received data:', data);
                if (data.photos && data.photos.length > 0) {
                    data.photos.forEach(photo => {
                        const photoHtml = createPhotoHTML(photo);
                        photosContainer.insertAdjacentHTML('beforeend', photoHtml);
                    });
                    currentPage = data.current_page;
                    hasMorePhotos = data.has_next;
                    console.log('Loaded photos, new page:', currentPage, 'hasMore:', hasMorePhotos);
                    
                    // Reinitialize event listeners for new photos
                    initializeNewPhotoEventListeners();
                } else {
                    hasMorePhotos = false;
                    console.log('No more photos to load');
                }
                
                if (!hasMorePhotos) {
                    endIndicator.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading photos:', error);
            })
            .finally(() => {
                isLoading = false;
                loadingIndicator.style.display = 'none';
            });
    }

    function createPhotoHTML(photo) {
        return `
            <div class="col photo-item" data-id="${photo.id}" data-order="${currentPage * 12 + 1}">
                <div class="card h-100 shadow-sm position-relative" role="listitem">
                    <div class="reorder-indicator" style="display: none;">Drag to reorder</div>
                    <div class="form-check position-absolute m-2" style="z-index:2;">
                        <input class="form-check-input photo-checkbox" type="checkbox" name="photo_ids" value="${photo.id}" id="photo-check-${photo.id}" aria-label="Select photo ${photo.title}">
                    </div>
                    <a href="/photo/${photo.id}/">
                        <img src="${photo.image_url}" class="card-img-top" alt="${photo.title} by ${photo.user}">
                    </a>
                    <div class="card-body">
                        <h5 class="card-title">${photo.title}</h5>
                        <p class="card-text text-muted small">
                            Uploaded on ${photo.uploaded_at}<br>
                            <span>Size: ${photo.file_size_formatted}</span>
                        </p>
                    </div>
                    <div class="card-footer text-center">
                        <a href="/photo/${photo.id}/" class="btn btn-sm btn-outline-primary" aria-label="View photo ${photo.title}">
                            <i class="fas fa-eye"></i> View
                        </a>
                        <form action="/photo/${photo.id}/delete/" method="post" class="d-inline single-delete-form">
                            {% csrf_token %}
                            <button type="button" class="btn btn-sm btn-outline-danger single-delete-btn" aria-label="Delete photo ${photo.title}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        `;
    }

    function initializeNewPhotoEventListeners() {
        // Add event listeners for new photo checkboxes
        const newCheckboxes = photosContainer.querySelectorAll('.photo-checkbox:not([data-initialized])');
        newCheckboxes.forEach(cb => {
            cb.addEventListener('change', updateBulkButtons);
            cb.setAttribute('data-initialized', 'true');
        });

        // Add event listeners for new delete buttons
        const newDeleteBtns = photosContainer.querySelectorAll('.single-delete-btn:not([data-initialized])');
        newDeleteBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                singleDeleteFormToSubmit = btn.closest('form');
                var modal = new bootstrap.Modal(document.getElementById('singleDeleteModal'));
                modal.show();
            });
            btn.setAttribute('data-initialized', 'true');
        });
    }

    // Intersection Observer for infinite scroll
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && hasMorePhotos && !isLoading) {
                console.log('Loading more photos...'); // Debug log
                loadMorePhotos();
            }
        });
    }, {
        rootMargin: '200px', // Increased margin to trigger earlier
        threshold: 0.1
    });

    // Observe the loading indicator
    if (loadingIndicator) {
        observer.observe(loadingIndicator);
        console.log('Observer set up for loading indicator'); // Debug log
    }

    // Also observe the end indicator as a fallback
    if (endIndicator) {
        observer.observe(endIndicator);
    }

    function initializeSortable() {
        if (photosContainer) {
            photosSortable = new Sortable(photosContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                disabled: true,
                // Mobile drag: instant drag on touch
                delay: 0,
                touchStartThreshold: 1,
                // Android Chrome specific options
                preventOnFilter: false,
                onStart: function(evt) {
                    // Ensure touch events work properly
                    if (evt.originalEvent && evt.originalEvent.touches) {
                        evt.originalEvent.preventDefault();
                    }
                },
                onEnd: function(evt) {
                    if (reorderMode) {
                        const item = evt.item;
                        const newIndex = evt.newIndex;
                        const photoId = item.dataset.id;
                        // Update data-order attributes
                        const items = photosContainer.querySelectorAll('.photo-item');
                        items.forEach((item, index) => {
                            item.dataset.order = index;
                        });
                        reorderPhoto(photoId, newIndex);
                    }
                }
            });
        }
    }

    function toggleReorderMode() {
        reorderMode = !reorderMode;
        if (reorderMode) {
            toggleButton.innerHTML = '<i class="fas fa-check"></i> Exit Reorder Mode';
            toggleButton.classList.remove('btn-outline-warning');
            toggleButton.classList.add('btn-warning');
            if (photosSortable) photosSortable.option('disabled', false);
            document.querySelectorAll('.reorder-indicator').forEach(ind => ind.style.display = 'block');
            document.querySelectorAll('.photo-item').forEach(item => {
                item.classList.add('reorder-active');
            });
            if (reorderHint) reorderHint.style.display = 'block';
        } else {
            toggleButton.innerHTML = '<i class="fas fa-arrows-alt"></i> Toggle Reorder Mode';
            toggleButton.classList.remove('btn-warning');
            toggleButton.classList.add('btn-outline-warning');
            if (photosSortable) photosSortable.option('disabled', true);
            document.querySelectorAll('.reorder-indicator').forEach(ind => ind.style.display = 'none');
            document.querySelectorAll('.photo-item').forEach(item => {
                item.classList.remove('reorder-active');
            });
            if (reorderHint) reorderHint.style.display = 'none';
        }
    }

    // Initialize existing functionality
    initializeSortable();
    if (toggleButton) toggleButton.addEventListener('click', toggleReorderMode);
    
    // Initialize event listeners for existing photos
    initializeNewPhotoEventListeners();

    // Add scroll event listener as fallback for infinite scroll
    window.addEventListener('scroll', function() {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 300) {
            if (hasMorePhotos && !isLoading) {
                console.log('Scroll fallback triggered');
                loadMorePhotos();
            }
        }
    });

    // Initial check - if we have less than 12 photos, we might not need infinite scroll
    const initialPhotos = photosContainer.querySelectorAll('.photo-item');
    if (initialPhotos.length < 12) {
        console.log('Less than 12 photos initially, checking if we need to load more');
        hasMorePhotos = false;
        endIndicator.style.display = 'block';
    }
});
</script>
{% endblock %}
{% endblock %} 